name: brew test-bot

on:
  pull_request:

jobs:
  tests:
    runs-on: macos-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v3

      # - name: Set up Homebrew
      #   id: set-up-homebrew
      #   uses: Homebrew/actions/setup-homebrew@master
      #
      # - name: Cache Homebrew Bundler RubyGems
      #   id: cache
      #   uses: actions/cache@v3
      #   with:
      #     path: ${{ steps.set-up-homebrew.outputs.gems-path }}
      #     key: ${{ runner.os }}-rubygems-${{ steps.set-up-homebrew.outputs.gems-hash }}
      #     restore-keys: ${{ runner.os }}-rubygems-
      #
      # - name: Install Homebrew Bundler RubyGems
      #   if: steps.cache.outputs.cache-hit != 'true'
      #   run: brew install-bundler-gems

      # - run: brew test-bot --only-cleanup-before
      #
      # - run: brew test-bot --only-setup
      #
      # - run: brew test-bot --only-tap-syntax
      #
      # - run: brew test-bot --only-formulae

      - name: Kick off publish workflow
        if: startsWith(github.event.pull_request.title, 'release:')
        run: |
          FORMULA=$(echo '${{ github.event.pull_request.title }}' | awk -F ' ' '{print $2}')
          VERSION=$(echo '${{ github.event.pull_request.title }}' | awk -F ' ' '{print $3}')
          gh workflow run publish.yml -f branch=${{ github.event.pull_request.head.ref }} -f formula=${FORMULA} -f version=${VERSION}
